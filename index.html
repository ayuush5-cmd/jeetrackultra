<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JEE Study & Practice Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0b0f19;
      color: #f5f5f5;
    }
    header {
      padding: 12px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
    }
    header h1 {
      margin: 0;
      font-size: 1.3rem;
    }
    header p {
      margin: 2px 0 0;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .tabs {
      display: flex;
      gap: 6px;
      padding: 8px 12px;
      border-bottom: 1px solid #1f2937;
      background: #020617;
    }
    .tab-btn {
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #2563eb;
      border-color: #2563eb;
    }
    main {
      padding: 14px;
      max-width: 1100px;
      margin: 0 auto;
    }
    h2, h3 {
      margin-top: 0;
      color: #e5e7eb;
    }
    section {
      background: #111827;
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 16px;
      border: 1px solid #1f2937;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .stat-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .stat {
      flex: 1;
      min-width: 100px;
    }
    .stat span.label {
      display: block;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .stat span.value {
      font-size: 1.2rem;
      font-weight: 600;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.85rem;
      color: #d1d5db;
    }
    input, select, textarea, button {
      width: 100%;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-family: inherit;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      margin-top: 10px;
      cursor: pointer;
      background: #2563eb;
      border-color: #2563eb;
      font-weight: 500;
    }
    button:hover {
      background: #1d4ed8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
      text-align: left;
    }
    th {
      background: #020617;
      color: #9ca3af;
      font-weight: 500;
    }
    tr:nth-child(even) td {
      background: #020617;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
    }
    .badge-high { background: #b91c1c; color: #fee2e2; }
    .badge-med { background: #92400e; color: #ffedd5; }
    .badge-low { background: #065f46; color: #d1fae5; }
    .chip {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: 0.75rem;
      color: #e5e7eb;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    .muted {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }
    #resetAll {
      background: #dc2626;
      border-color: #b91c1c;
    }
    #resetAll:hover {
      background: #b91c1c;
    }
    .tab-pane {
      display: none;
    }
    .tab-pane.active {
      display: block;
    }
    .inline-note {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 2px;
    }
    @media (max-width: 600px) {
      header h1 { font-size: 1.1rem; }
      main { padding: 10px; }
    }
  </style>
</head>
<body>
<header>
  <h1>JEE Study & Practice Tracker</h1>
  <p>Local-only tracker for JEE Main & Advanced – nothing is uploaded anywhere.</p>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="dashTab">Dashboard</button>
  <button class="tab-btn" data-tab="studyTab">Study</button>
  <button class="tab-btn" data-tab="practiceTab">Practice</button>
  <button class="tab-btn" data-tab="settingsTab">Settings</button>
</div>

<main>

  <!-- DASHBOARD TAB -->
  <div id="dashTab" class="tab-pane active">

    <section>
      <div class="flex-between">
        <h2>Today’s Target</h2>
        <span class="muted" id="todayDate"></span>
      </div>
      <p class="muted">Focus topics pulled from your pending list. Finish at least one topic per subject daily.</p>
      <div id="todayTargets"></div>
    </section>

    <div class="grid">
      <section>
        <h2>Study Progress</h2>
        <p class="muted">Completion across Physics, Chemistry and Maths.</p>
        <div class="stat-row">
          <div class="stat">
            <span class="label">Physics</span>
            <span class="value" id="phyPercent">0%</span>
          </div>
          <div class="stat">
            <span class="label">Chemistry</span>
            <span class="value" id="chemPercent">0%</span>
          </div>
          <div class="stat">
            <span class="label">Maths</span>
            <span class="value" id="mathPercent">0%</span>
          </div>
        </div>
        <hr style="border-color:#1f2937;margin:10px 0;">
        <div class="stat-row">
          <div class="stat">
            <span class="label">Total topics</span>
            <span class="value" id="totalTopics">0</span>
          </div>
          <div class="stat">
            <span class="label">Completed</span>
            <span class="value" id="completedTopics">0</span>
          </div>
          <div class="stat">
            <span class="label">Overall %</span>
            <span class="value" id="overallPercent">0%</span>
          </div>
        </div>
      </section>

      <section>
        <h2>Practice Snapshot</h2>
        <p class="muted">Mocks & PYQs across JEE Main and Advanced.</p>
        <div class="stat-row">
          <div class="stat">
            <span class="label">Tests logged</span>
            <span class="value" id="testsLogged">0</span>
          </div>
          <div class="stat">
            <span class="label">Avg. score</span>
            <span class="value" id="avgScore">0</span>
          </div>
          <div class="stat">
            <span class="label">Avg. accuracy</span>
            <span class="value" id="avgAccuracy">0%</span>
          </div>
        </div>
        <hr style="border-color:#1f2937;margin:10px 0;">
        <div class="stat-row">
          <div class="stat">
            <span class="label">Best score</span>
            <span class="value" id="bestScore">0</span>
          </div>
          <div class="stat">
            <span class="label">Worst score</span>
            <span class="value" id="worstScore">0</span>
          </div>
          <div class="stat">
            <span class="label">Recent avg score</span>
            <span class="value" id="recentAvgScore">0</span>
          </div>
        </div>
      </section>

      <section>
        <h2>Consistency</h2>
        <p class="muted">Try not to break your streak.</p>
        <div class="stat-row">
          <div class="stat">
            <span class="label">Current study streak</span>
            <span class="value" id="streakDays">0 days</span>
          </div>
          <div class="stat">
            <span class="label">Last active</span>
            <span class="value" id="lastActive">–</span>
          </div>
        </div>
      </section>
    </div>

  </div>

  <!-- STUDY TAB -->
  <div id="studyTab" class="tab-pane">

    <section>
      <h2>Add Topic</h2>
      <p class="muted">Choose subject & chapter; optionally add subtopics.</p>

      <form id="topicForm">
        <div class="grid">
          <div>
            <label>Subject</label>
            <select id="topicSubject" required>
              <option value="">Select subject</option>
              <option value="Physics">Physics</option>
              <option value="Chemistry">Chemistry</option>
              <option value="Maths">Maths</option>
            </select>
          </div>
          <div>
            <label>Topic / Chapter</label>
            <input id="topicName" type="text" placeholder="e.g. Electrostatics" required>
          </div>
          <div>
            <label>Priority</label>
            <select id="topicPriority" required>
              <option value="High">High</option>
              <option value="Medium" selected>Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div>
            <label>Target date</label>
            <input id="topicTarget" type="date">
          </div>
        </div>
        <label>Subtopics (optional, comma separated)</label>
        <input id="topicSubtopics" type="text" placeholder="Kinematics 1D, Kinematics 2D">
        <button type="submit">Add Topic</button>
      </form>
    </section>

    <section>
      <h2>Topics</h2>
      <h3>Filter & Quick View</h3>
      <div class="grid">
        <div>
          <label>Subject filter</label>
          <select id="filterSubject">
            <option value="All">All</option>
            <option value="Physics">Physics</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Maths">Maths</option>
          </select>
        </div>
        <div>
          <label>Status filter</label>
          <select id="filterStatus">
            <option value="All">All</option>
            <option value="Pending">Pending</option>
            <option value="Done">Done</option>
          </select>
        </div>
        <div>
          <label>Priority filter</label>
          <select id="filterPriority">
            <option value="All">All</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
        </div>
      </div>

      <h3 style="margin-top:12px;">Topic List</h3>
      <div class="muted">Use “Mark done” when confident with a topic.</div>
      <table>
        <thead>
          <tr>
            <th>Subject</th>
            <th>Topic</th>
            <th>Priority</th>
            <th>Target</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="topicTableBody"></tbody>
      </table>
    </section>

  </div>

  <!-- PRACTICE TAB -->
  <div id="practiceTab" class="tab-pane">

    <section>
      <h2>Log Mock / PYQ</h2>
      <p class="muted">Choose exam category first – JEE Main (300 marks) or JEE Advanced (180 marks).</p>

      <form id="testForm">
        <div class="grid">
          <div>
            <label>Exam category</label>
            <select id="testExam" required>
              <option value="">Select category</option>
              <option value="JEE Main">JEE Main (300)</option>
              <option value="JEE Advanced">JEE Advanced (180)</option>
            </select>
            <div class="inline-note" id="maxMarksNote">Max marks: –</div>
          </div>
          <div>
            <label>Type</label>
            <select id="testType" required>
              <option value="">Select type</option>
              <option value="Mock">Mock</option>
              <option value="PYQ">PYQ</option>
            </select>
          </div>
          <div>
            <label>Score</label>
            <input type="number" id="testScore" min="0" required>
          </div>
          <div>
            <label>Total questions</label>
            <input type="number" id="testTotalQ" min="1" required>
          </div>
          <div>
            <label>Correct questions</label>
            <input type="number" id="testCorrectQ" min="0" required>
          </div>
          <div>
            <label>Accuracy (%)</label>
            <input type="number" id="testAccuracy" readonly>
          </div>
        </div>
        <label>Reflection / mistakes (short)</label>
        <textarea id="testReflection" placeholder="Key mistakes, chapters to revise, silly errors, time management, etc."></textarea>
        <button type="submit">Save Test</button>
      </form>
    </section>

    <section>
      <h2>Recent Tests</h2>
      <p class="muted">Last few entries – both JEE Main and Advanced.</p>
      <table>
        <thead>
          <tr>
            <th>Exam</th>
            <th>Type</th>
            <th>Score</th>
            <th>Acc%</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="recentTestsBody"></tbody>
      </table>
    </section>

    <section id="mistakeLogSection">
      <h2>Previously Made Mistakes</h2>
      <p class="muted">Review this before new tests so you do not repeat the same errors.</p>
      <ul id="mistakeLogList" class="muted"></ul>
    </section>

  </div>

  <!-- SETTINGS TAB -->
  <div id="settingsTab" class="tab-pane">

    <section>
      <h2>Basic Settings</h2>
      <p class="muted">Set your JEE target date and daily dashboard load.</p>
      <div class="grid">
        <div>
          <label>Target exam date</label>
          <input type="date" id="targetExamDate">
        </div>
        <div>
          <label>Daily topics to surface</label>
          <input type="number" id="dailyTopicCount" min="1" value="3">
        </div>
      </div>
    </section>

    <section>
      <h2>Reset</h2>
      <p class="muted">Clear topics, tests, streak and settings from this browser.</p>
      <button id="resetAll">Reset everything</button>
    </section>

  </div>

</main>

<script>
  // -------- Tabs ----------
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabPanes = document.querySelectorAll('.tab-pane');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.tab;
      tabButtons.forEach(b => b.classList.remove('active'));
      tabPanes.forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(target).classList.add('active');
    });
  });

  // ---------- Helpers ----------
  function getArray(key) {
    return JSON.parse(localStorage.getItem(key) || '[]');
  }
  function setArray(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }
  function todayStr() {
    return new Date().toISOString().split('T')[0];
  }

  // ---------- Topics ----------
  function getTopics() { return getArray('topics'); }
  function saveTopics(t) { setArray('topics', t); }

  const topicForm = document.getElementById('topicForm');
  if (topicForm) {
    topicForm.addEventListener('submit', e => {
      e.preventDefault();
      const subject = document.getElementById('topicSubject').value;
      const name = document.getElementById('topicName').value.trim();
      const priority = document.getElementById('topicPriority').value;
      const target = document.getElementById('topicTarget').value;
      const subtopics = document.getElementById('topicSubtopics').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
      if (!subject || !name) return;
      const topics = getTopics();
      topics.push({
        id: Date.now(),
        subject,
        name,
        priority,
        target,
        subtopics,
        status: 'Pending',
        createdAt: todayStr(),
        doneAt: null
      });
      saveTopics(topics);
      topicForm.reset();
      renderTopics();
      updateStudyStats();
      updateTodayTargets();
    });
  }

  const topicTableBody = document.getElementById('topicTableBody');
  const filterSubject = document.getElementById('filterSubject');
  const filterStatus = document.getElementById('filterStatus');
  const filterPriority = document.getElementById('filterPriority');

  function renderTopics() {
    if (!topicTableBody) return;
    const topics = getTopics();
    const sf = filterSubject ? filterSubject.value : 'All';
    const st = filterStatus ? filterStatus.value : 'All';
    const sp = filterPriority ? filterPriority.value : 'All';

    const filtered = topics.filter(t => {
      if (sf !== 'All' && t.subject !== sf) return false;
      if (st !== 'All' && t.status !== st) return false;
      if (sp !== 'All' && t.priority !== sp) return false;
      return true;
    });

    topicTableBody.innerHTML = '';
    if (!filtered.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.textContent = 'No topics added yet.';
      td.className = 'muted';
      tr.appendChild(td);
      topicTableBody.appendChild(tr);
      return;
    }

    filtered.forEach(t => {
      const tr = document.createElement('tr');

      const subjectTd = document.createElement('td');
      subjectTd.textContent = t.subject;
      tr.appendChild(subjectTd);

      const topicTd = document.createElement('td');
      const nameDiv = document.createElement('div');
      nameDiv.textContent = t.name;
      topicTd.appendChild(nameDiv);
      if (t.subtopics && t.subtopics.length) {
        const subDiv = document.createElement('div');
        subDiv.className = 'muted';
        subDiv.style.fontSize = '0.75rem';
        subDiv.textContent = 'Sub: ' + t.subtopics.join(', ');
        topicTd.appendChild(subDiv);
      }
      tr.appendChild(topicTd);

      const prTd = document.createElement('td');
      const badge = document.createElement('span');
      badge.textContent = t.priority;
      badge.classList.add('badge');
      if (t.priority === 'High') badge.classList.add('badge-high');
      else if (t.priority === 'Medium') badge.classList.add('badge-med');
      else badge.classList.add('badge-low');
      prTd.appendChild(badge);
      tr.appendChild(prTd);

      const targetTd = document.createElement('td');
      targetTd.textContent = t.target || '–';
      tr.appendChild(targetTd);

      const statusTd = document.createElement('td');
      statusTd.textContent = t.status;
      statusTd.className = 'muted';
      tr.appendChild(statusTd);

      const actionTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = t.status === 'Done' ? 'Mark pending' : 'Mark done';
      btn.style.padding = '4px 8px';
      btn.style.fontSize = '0.75rem';
      btn.addEventListener('click', () => toggleTopicStatus(t.id));
      actionTd.appendChild(btn);
      tr.appendChild(actionTd);

      topicTableBody.appendChild(tr);
    });
  }

  function toggleTopicStatus(id) {
    const topics = getTopics();
    const idx = topics.findIndex(t => t.id === id);
    if (idx === -1) return;
    const topic = topics[idx];
    if (topic.status === 'Done') {
      topic.status = 'Pending';
      topic.doneAt = null;
    } else {
      topic.status = 'Done';
      topic.doneAt = todayStr();
    }
    topics[idx] = topic;
    saveTopics(topics);
    renderTopics();
    updateStudyStats();
    updateTodayTargets();
    updateStreak(todayStr());
  }

  if (filterSubject) filterSubject.addEventListener('change', renderTopics);
  if (filterStatus) filterStatus.addEventListener('change', renderTopics);
  if (filterPriority) filterPriority.addEventListener('change', renderTopics);

  function updateStudyStats() {
    const topics = getTopics();
    const total = topics.length;
    const done = topics.filter(t => t.status === 'Done').length;

    const totalTopicsEl = document.getElementById('totalTopics');
    const completedTopicsEl = document.getElementById('completedTopics');
    const overallPercentEl = document.getElementById('overallPercent');

    if (totalTopicsEl) totalTopicsEl.textContent = total;
    if (completedTopicsEl) completedTopicsEl.textContent = done;
    if (overallPercentEl) {
      const pct = total ? ((done / total) * 100).toFixed(1) : '0';
      overallPercentEl.textContent = pct + '%';
    }

    const subs = ['Physics', 'Chemistry', 'Maths'];
    const perc = { Physics: 0, Chemistry: 0, Maths: 0 };
    subs.forEach(s => {
      const all = topics.filter(t => t.subject === s).length;
      const c = topics.filter(t => t.subject === s && t.status === 'Done').length;
      perc[s] = all ? (c / all) * 100 : 0;
    });

    const phyEl = document.getElementById('phyPercent');
    const chemEl = document.getElementById('chemPercent');
    const mathEl = document.getElementById('mathPercent');
    if (phyEl) phyEl.textContent = perc.Physics.toFixed(1) + '%';
    if (chemEl) chemEl.textContent = perc.Chemistry.toFixed(1) + '%';
    if (mathEl) mathEl.textContent = perc.Maths.toFixed(1) + '%';
  }

  function updateTodayTargets() {
    const container = document.getElementById('todayTargets');
    if (!container) return;
    const dailyInput = document.getElementById('dailyTopicCount');
    const dailyCount = dailyInput ? Number(dailyInput.value || 3) : 3;
    const topics = getTopics();
    const pending = topics.filter(t => t.status === 'Pending');

    pending.sort((a, b) => {
      const order = { High: 0, Medium: 1, Low: 2 };
      const pa = order[a.priority] ?? 2;
      const pb = order[b.priority] ?? 2;
      if (pa !== pb) return pa - pb;
      if (a.target && b.target) return a.target.localeCompare(b.target);
      if (a.target && !b.target) return -1;
      if (!a.target && b.target) return 1;
      return a.createdAt.localeCompare(b.createdAt);
    });

    const pick = pending.slice(0, dailyCount);
    container.innerHTML = '';
    if (!pick.length) {
      const span = document.createElement('span');
      span.className = 'muted';
      span.textContent = 'No pending topics. Add some or mark a few back to pending.';
      container.appendChild(span);
      return;
    }
    pick.forEach(t => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = `${t.subject}: ${t.name}`;
      container.appendChild(chip);
    });
  }

  // ---------- Tests ----------
  function getTests() { return getArray('tests'); }
  function saveTests(t) { setArray('tests', t); }

  const testExam = document.getElementById('testExam');
  const testScore = document.getElementById('testScore');
  const maxMarksNote = document.getElementById('maxMarksNote');

  function updateMaxMarks() {
    let max = null;
    if (testExam.value === 'JEE Main') max = 300;
    else if (testExam.value === 'JEE Advanced') max = 180;
    if (max !== null) {
      maxMarksNote.textContent = `Max marks: ${max}`;
      testScore.max = max;
    } else {
      maxMarksNote.textContent = 'Max marks: –';
      testScore.removeAttribute('max');
    }
  }
  if (testExam) testExam.addEventListener('change', updateMaxMarks);

  const totalQInput = document.getElementById('testTotalQ');
  const correctQInput = document.getElementById('testCorrectQ');
  const accuracyInput = document.getElementById('testAccuracy');

  function updateAccuracyField() {
    const total = parseInt(totalQInput.value, 10);
    const correct = parseInt(correctQInput.value, 10);
    if (!isNaN(total) && total > 0 && !isNaN(correct) && correct >= 0 && correct <= total) {
      const acc = (correct / total) * 100;
      accuracyInput.value = acc.toFixed(1);
    } else {
      accuracyInput.value = '';
    }
  }
  if (totalQInput && correctQInput) {
    totalQInput.addEventListener('input', updateAccuracyField);
    correctQInput.addEventListener('input', updateAccuracyField);
  }

  const testForm = document.getElementById('testForm');
  if (testForm) {
    testForm.addEventListener('submit', e => {
      e.preventDefault();
      const exam = testExam.value;
      const type = document.getElementById('testType').value;
      const score = Number(testScore.value);
      const totalQ = Number(totalQInput.value);
      const correctQ = Number(correctQInput.value);
      const reflection = document.getElementById('testReflection').value.trim();
      let maxMarks = exam === 'JEE Main' ? 300 : exam === 'JEE Advanced' ? 180 : null;

      if (!exam || !type || isNaN(score) || !totalQ || totalQ <= 0 || correctQ < 0 || correctQ > totalQ) {
        alert('Fill exam category, type, valid score and question details.');
        return;
      }
      if (maxMarks !== null && (score < 0 || score > maxMarks)) {
        alert(`Score must be between 0 and ${maxMarks}.`);
        return;
      }

      const accuracy = (correctQ / totalQ) * 100;

      const tests = getTests();
      tests.push({
        id: Date.now(),
        exam,
        maxMarks,
        type,
        score,
        totalQ,
        correctQ,
        accuracy,
        reflection,
        date: todayStr()
      });
      saveTests(tests);

      testForm.reset();
      maxMarksNote.textContent = 'Max marks: –';
      if (accuracyInput) accuracyInput.value = '';

      renderTests();
      updatePracticeStats();
      updateMistakeLog();
      updateStreak(todayStr());
    });
  }

  function updatePracticeStats() {
    const tests = getTests();
    const n = tests.length;
    const testsLoggedEl = document.getElementById('testsLogged');
    const avgScoreEl = document.getElementById('avgScore');
    const avgAccuracyEl = document.getElementById('avgAccuracy');
    const bestScoreEl = document.getElementById('bestScore');
    const worstScoreEl = document.getElementById('worstScore');
    const recentAvgScoreEl = document.getElementById('recentAvgScore');

    if (testsLoggedEl) testsLoggedEl.textContent = n;

    let avgScore = 0, avgAcc = 0, best = 0, worst = 0, recentAvg = 0;
    if (n) {
      const totalScore = tests.reduce((s, t) => s + (t.score || 0), 0);
      const totalAcc = tests.reduce((s, t) => s + (t.accuracy || 0), 0);
      avgScore = totalScore / n;
      avgAcc = totalAcc / n;
      best = Math.max(...tests.map(t => t.score || 0));
      worst = Math.min(...tests.map(t => t.score || 0));
      const recent = tests.slice(-5);
      const recentTotalScore = recent.reduce((s, t) => s + (t.score || 0), 0);
      recentAvg = recentTotalScore / recent.length;
    }

    if (avgScoreEl) avgScoreEl.textContent = avgScore.toFixed(1);
    if (avgAccuracyEl) avgAccuracyEl.textContent = avgAcc.toFixed(1) + '%';
    if (bestScoreEl) bestScoreEl.textContent = best.toFixed(1);
    if (worstScoreEl) worstScoreEl.textContent = worst.toFixed(1);
    if (recentAvgScoreEl) recentAvgScoreEl.textContent = recentAvg.toFixed(1);
  }

  function renderTests() {
    const tbody = document.getElementById('recentTestsBody');
    if (!tbody) return;
    const tests = getTests().sort((a, b) => b.id - a.id);
    const recent = tests.slice(0, 5);
    tbody.innerHTML = '';
    if (!recent.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = 'No tests logged yet.';
      td.className = 'muted';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    recent.forEach(t => {
      const tr = document.createElement('tr');
      const examTd = document.createElement('td');
      const typeTd = document.createElement('td');
      const scoreTd = document.createElement('td');
      const accTd = document.createElement('td');
      const dateTd = document.createElement('td');

      examTd.textContent = t.exam;
      scoreTd.textContent = `${t.score}/${t.maxMarks || ''}`.trim();
      typeTd.textContent = t.type;
      accTd.textContent = t.accuracy.toFixed(1);
      dateTd.textContent = t.date;

      tr.appendChild(examTd);
      tr.appendChild(typeTd);
      tr.appendChild(scoreTd);
      tr.appendChild(accTd);
      tr.appendChild(dateTd);
      tbody.appendChild(tr);
    });
  }

  function updateMistakeLog() {
    const list = document.getElementById('mistakeLogList');
    if (!list) return;
    const tests = getTests();
    const withMistakes = tests
      .filter(t => t.reflection && t.reflection.trim().length)
      .sort((a, b) => b.id - a.id)
      .slice(0, 10);

    list.innerHTML = '';
    if (!withMistakes.length) {
      const li = document.createElement('li');
      li.textContent = 'No logged mistakes yet. Add reflections when you log tests.';
      list.appendChild(li);
      return;
    }
    withMistakes.forEach(t => {
      const li = document.createElement('li');
      li.textContent = `${t.date} • ${t.exam} ${t.type} • Acc: ${t.accuracy.toFixed(1)}% • ${t.reflection}`;
      list.appendChild(li);
    });
  }

  // ---------- Streak ----------
  function getMeta() {
    return JSON.parse(localStorage.getItem('meta') || '{"streak":0,"lastActive":null}');
  }
  function saveMeta(meta) {
    localStorage.setItem('meta', JSON.stringify(meta));
  }
  function updateStreak(actionDateStr) {
    if (!actionDateStr) return;
    const meta = getMeta();
    const today = actionDateStr;
    const last = meta.lastActive;
    if (!last) {
      meta.streak = 1;
    } else {
      const lastDate = new Date(last);
      const currDate = new Date(today);
      const diffDays = Math.floor((currDate - lastDate) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) {
        // same day
      } else if (diffDays === 1) {
        meta.streak = (meta.streak || 0) + 1;
      } else if (diffDays > 1) {
        meta.streak = 1;
      }
    }
    meta.lastActive = today;
    saveMeta(meta);
    renderStreak();
  }
  function renderStreak() {
    const meta = getMeta();
    const streakEl = document.getElementById('streakDays');
    const lastEl = document.getElementById('lastActive');
    if (streakEl) streakEl.textContent = (meta.streak || 0) + ' days';
    if (lastEl) lastEl.textContent = meta.lastActive || '–';
  }

  // ---------- Settings ----------
  const dailyTopicCountInput = document.getElementById('dailyTopicCount');
  const targetExamDateInput = document.getElementById('targetExamDate');

  function loadSettings() {
    const s = JSON.parse(localStorage.getItem('settings') || '{}');
    if (s.dailyTopicCount && dailyTopicCountInput) dailyTopicCountInput.value = s.dailyTopicCount;
    if (s.targetExamDate && targetExamDateInput) targetExamDateInput.value = s.targetExamDate;
  }
  function saveSettings() {
    const s = {
      dailyTopicCount: dailyTopicCountInput ? Number(dailyTopicCountInput.value || 3) : 3,
      targetExamDate: targetExamDateInput ? targetExamDateInput.value : null
    };
    localStorage.setItem('settings', JSON.stringify(s));
    updateTodayTargets();
  }
  if (dailyTopicCountInput) dailyTopicCountInput.addEventListener('change', saveSettings);
  if (targetExamDateInput) targetExamDateInput.addEventListener('change', saveSettings);

  // ---------- Reset ----------
  const resetBtn = document.getElementById('resetAll');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      if (!confirm('Reset topics, tests, streak and settings?')) return;
      localStorage.removeItem('topics');
      localStorage.removeItem('tests');
      localStorage.removeItem('meta');
      localStorage.removeItem('settings');
      renderTopics();
      updateStudyStats();
      updateTodayTargets();
      renderTests();
      updatePracticeStats();
      updateMistakeLog();
      renderStreak();
    });
  }

  // ---------- Initial ----------
  document.addEventListener('DOMContentLoaded', () => {
    const dEl = document.getElementById('todayDate');
    if (dEl) {
      const d = new Date();
      dEl.textContent = d.toLocaleDateString(undefined, {
        weekday: 'short',
        day: 'numeric',
        month: 'short'
      });
    }
    loadSettings();
    renderTopics();
    updateStudyStats();
    updateTodayTargets();
    renderTests();
    updatePracticeStats();
    updateMistakeLog();
    renderStreak();
    updateMaxMarks();
  });
</script>

</body>
</html>

