<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My JEE Prep Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.5;
    }
    header {
      background: #111827;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #1f2937;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { font-size: 1.35rem; color: #f9fafb; }
    header span { font-size: 0.9rem; color: #9ca3af; }
    main { max-width: 1100px; margin: 1.5rem auto; padding: 0 1rem 2rem; }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #d1d5db;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .tab-btn.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #f9fafb;
    }
    section {
      display: none;
      animation: fade 0.2s ease-out;
    }
    section.active { display: block; }
    @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

    .grid {
      display: grid;
      gap: 1rem;
    }
    @media (min-width: 768px) {
      .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1px solid #1f2937;
    }
    .card h2 { font-size: 1rem; margin-bottom: 0.6rem; color: #e5e7eb; }
    .muted { color: #9ca3af; font-size: 0.85rem; }
    .stat-number {
      font-size: 1.3rem;
      font-weight: 600;
      margin-top: 0.15rem;
    }
    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      font-size: 0.7rem;
      background: #111827;
      border: 1px solid #1f2937;
      color: #9ca3af;
      margin-left: 0.4rem;
    }
    .tag {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #111827;
      color: #d1d5db;
      margin-right: 0.25rem;
      margin-top: 0.25rem;
    }
    .tag-phy { border: 1px solid #22c55e33; }
    .tag-chem { border: 1px solid #eab30833; }
    .tag-math { border: 1px solid #38bdf833; }

    form {
      display: grid;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    label { display: block; margin-bottom: 0.25rem; }
    input, select, textarea {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }
    textarea { min-height: 60px; resize: vertical; }
    button {
      border: none;
      border-radius: 0.5rem;
      padding: 0.45rem 0.9rem;
      background: #2563eb;
      color: #f9fafb;
      font-size: 0.85rem;
      cursor: pointer;
    }
    button.secondary {
      background: #020617;
      border: 1px solid #4b5563;
      color: #e5e7eb;
    }
    button.small { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }
    th, td {
      border-bottom: 1px solid #111827;
      padding: 0.4rem 0.3rem;
      text-align: left;
    }
    th { color: #9ca3af; font-weight: 500; font-size: 0.78rem; }
    tr:last-child td { border-bottom: none; }
    .danger { color: #f97373; }
    .flex { display: flex; align-items: center; gap: 0.35rem; flex-wrap: wrap; }
    .justify-between { justify-content: space-between; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mb-1 { margin-bottom: 0.25rem; }
    .chip {
      font-size: 0.7rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>My JEE Prep Planner</h1>
      <span>Plan syllabus, track topics, tests & progress.</span>
    </div>
    <div>
      <span class="muted">Days left: <span id="daysLeft">–</span></span>
    </div>
  </header>

  <main>
    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn" data-tab="planner">Study Planner</button>
      <button class="tab-btn" data-tab="practice">Practice Tracker</button>
      <button class="tab-btn" data-tab="analysis">Analysis</button>
      <button class="tab-btn" data-tab="settings">Settings</button>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="active">
      <div class="grid grid-3">
        <div class="card">
          <h2>Today’s Target</h2>
          <p class="muted">Focus topics pulled from your pending list.</p>
          <ul id="todayList" class="mt-2 muted" style="list-style: disc; padding-left: 1.1rem;"></ul>
          <p class="muted mt-2"><span class="chip">Tip</span> Finish at least one topic per subject daily.</p>
        </div>

        <div class="card">
          <h2>Overall Progress <span class="badge">Study Planner</span></h2>
          <p class="muted">Quick view of topic completion across PCM.</p>
          <div class="mt-2">
            <p class="muted mb-1">Physics: <span id="phyProgress" class="stat-number">0%</span></p>
            <p class="muted mb-1">Chemistry: <span id="chemProgress" class="stat-number">0%</span></p>
            <p class="muted mb-1">Maths: <span id="mathProgress" class="stat-number">0%</span></p>
          </div>
        </div>

        <div class="card">
          <h2>Practice Snapshot <span class="badge">Mocks & PYQs</span></h2>
          <p class="muted">Keep an eye on accuracy and attempts.</p>
          <div class="mt-2">
            <p class="muted mb-1">Tests logged: <span id="testsCount" class="stat-number">0</span></p>
            <p class="muted mb-1">Avg. score (/300): <span id="avgScore" class="stat-number">0</span></p>
            <p class="muted mb-1">Avg. accuracy (%): <span id="avgAccuracy" class="stat-number">0</span></p>
          </div>
        </div>
      </div>
    </section>

    <!-- STUDY PLANNER -->
    <section id="planner">
      <div class="grid grid-2">
        <div class="card">
          <h2>Add Topic</h2>
          <p class="muted">Choose subject & chapter; optionally add subtopics.</p>
          <form id="topicForm">
            <div>
              <label for="subject">Subject</label>
              <select id="subject" required>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Maths">Maths</option>
              </select>
            </div>
            <div>
              <label for="chapterSelect">Chapter</label>
              <select id="chapterSelect"></select>
            </div>
            <div>
              <label for="topic">Extra details (optional)</label>
              <input id="topic" type="text" placeholder="e.g. Kinematics – Relative motion, Projectile" />
            </div>
            <div>
              <label for="priority">Priority</label>
              <select id="priority">
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div>
              <label for="targetDate">Target date</label>
              <input id="targetDate" type="date" />
            </div>
            <button type="submit">Add to planner</button>
          </form>
        </div>

        <div class="card">
          <h2>Filter & Quick View</h2>
          <div class="flex mt-1">
            <select id="filterSubject">
              <option value="All">All subjects</option>
              <option value="Physics">Physics</option>
              <option value="Chemistry">Chemistry</option>
              <option value="Maths">Maths</option>
            </select>
            <select id="filterStatus">
              <option value="All">All status</option>
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Done">Done</option>
            </select>
            <button id="clearAllTopics" class="secondary small">Clear all topics</button>
          </div>
          <p class="muted mt-2">Use filters to see what remains in each subject. Mark topics as you complete them.</p>
        </div>
      </div>

      <div class="card mt-2">
        <h2>Topic List</h2>
        <table id="topicsTable">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Topic</th>
              <th>Priority</th>
              <th>Target</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PRACTICE TRACKER -->
    <section id="practice">
      <div class="grid grid-2">
        <div class="card">
          <h2>Log Mock / PYQ</h2>
          <p class="muted">Track each test with score, accuracy, and a short reflection.</p>
          <form id="testForm">
            <div>
              <label for="testType">Type</label>
              <select id="testType">
                <option value="Full Test">Full Test</option>
                <option value="Physics">Physics Section</option>
                <option value="Chemistry">Chemistry Section</option>
                <option value="Maths">Maths Section</option>
                <option value="PYQ Set">PYQ Set</option>
              </select>
            </div>
            <div class="grid">
              <div>
                <label for="score">Score (out of 300)</label>
                <input id="score" type="number" min="0" max="300" />
              </div>
              <div>
                <label for="accuracy">Accuracy (%)</label>
                <input id="accuracy" type="number" min="0" max="100" />
              </div>
            </div>
            <div>
              <label for="testDate">Date</label>
              <input id="testDate" type="date" />
            </div>
            <div>
              <label for="notes">Key mistakes / topics to revise</label>
              <textarea id="notes" placeholder="e.g. Weak in Electrostatics numericals, Organic mechanisms confusion"></textarea>
            </div>
            <button type="submit">Add test</button>
          </form>
        </div>

        <div class="card">
          <h2>Recent Tests</h2>
          <p class="muted">Last few entries to quickly recall what to fix.</p>
          <table id="testsTable">
            <thead>
              <tr>
                <th>Type</th>
                <th>Score</th>
                <th>Acc%</th>
                <th>Date</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYSIS -->
    <section id="analysis">
      <div class="grid grid-3">
        <div class="card">
          <h2>Overall Completion</h2>
          <p class="muted">Based on your topic list.</p>
          <p class="muted mt-1">Total topics: <span id="anTotalTopics" class="stat-number">0</span></p>
          <p class="muted mt-1">Done: <span id="anDoneTopics" class="stat-number">0</span></p>
          <p class="muted mt-1">Overall %: <span id="anOverallPct" class="stat-number">0%</span></p>
        </div>
        <div class="card">
          <h2>Subject‑wise %</h2>
          <p class="muted mt-1">Physics: <span id="anPhyPct" class="stat-number">0%</span></p>
          <p class="muted mt-1">Chemistry: <span id="anChemPct" class="stat-number">0%</span></p>
          <p class="muted mt-1">Maths: <span id="anMathPct" class="stat-number">0%</span></p>
        </div>
        <div class="card">
          <h2>Consistency</h2>
          <p class="muted mt-1">Current study streak: <span id="anStreak" class="stat-number">0</span> days</p>
          <p class="muted mt-1">Last active: <span id="anLastActive" class="stat-number">–</span></p>
          <p class="muted mt-1"><span class="chip">Tip</span> Try not to break your streak.</p>
        </div>
      </div>

      <div class="card mt-2">
        <h2>Test Performance (last 5)</h2>
        <p class="muted">Quick view from your most recent mocks / PYQs.</p>
        <p class="muted mt-1">Best score: <span id="anBestScore" class="stat-number">0</span></p>
        <p class="muted mt-1">Worst score: <span id="anWorstScore" class="stat-number">0</span></p>
        <p class="muted mt-1">Recent avg score: <span id="anRecentAvgScore" class="stat-number">0</span></p>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings">
      <div class="card">
        <h2>Basic Settings</h2>
        <p class="muted">Set your JEE Main target date and how many dashboard topics you want for a day.</p>
        <form id="settingsForm">
          <div class="grid">
            <div>
              <label for="jeeDate">JEE Main target date</label>
              <input id="jeeDate" type="date" />
            </div>
            <div>
              <label for="dailyTargetCount">Topics per day (dashboard)</label>
              <input id="dailyTargetCount" type="number" min="1" max="10" value="3" />
            </div>
          </div>
          <button type="submit" class="mt-2">Save settings</button>
        </form>
        <p class="muted mt-2">All data is stored in your browser (localStorage). Use the button below to reset everything.</p>
        <button id="resetAll" class="secondary danger mt-1">Reset all data</button>
      </div>
    </section>
  </main>

  <script>
    const LS_KEYS = {
      topics: "jee_topics",
      tests: "jee_tests",
      settings: "jee_settings",
      meta: "jee_meta"
    };

    const CHAPTERS = {
      Physics: [
        "Units & Dimensions",
        "Kinematics",
        "Laws of Motion",
        "Work, Power & Energy",
        "Centre of Mass & Momentum",
        "Rotation",
        "Gravitation",
        "Simple Harmonic Motion",
        "Waves",
        "Thermal Physics",
        "Kinetic Theory of Gases",
        "Electrostatics",
        "Current Electricity",
        "Magnetic Effects of Current",
        "Electromagnetic Induction & AC",
        "Ray Optics",
        "Wave Optics",
        "Modern Physics & Nuclear",
        "Semiconductors & Communication"
      ],
      Chemistry: [
        "Some Basic Concepts of Chemistry",
        "Atomic Structure",
        "Periodic Table",
        "Chemical Bonding",
        "States of Matter",
        "Thermodynamics",
        "Equilibrium",
        "Redox Reactions",
        "Electrochemistry",
        "Chemical Kinetics",
        "Solutions",
        "Surface Chemistry",
        "s-Block Elements",
        "p-Block Elements",
        "d- and f-Block Elements",
        "Coordination Compounds",
        "General Organic Chemistry",
        "Hydrocarbons",
        "Haloalkanes & Haloarenes",
        "Alcohols, Phenols & Ethers",
        "Aldehydes, Ketones & Carboxylic Acids",
        "Amines",
        "Biomolecules & Polymers",
        "Environmental Chemistry"
      ],
      Maths: [
        "Sets, Relations & Functions",
        "Quadratic Equations",
        "Sequences & Series",
        "Binomial Theorem",
        "Complex Numbers",
        "Matrices & Determinants",
        "Permutations & Combinations",
        "Limits & Continuity",
        "Differentiation",
        "Applications of Derivatives",
        "Indefinite Integration",
        "Definite Integration",
        "Differential Equations",
        "Straight Lines & Pair of Lines",
        "Circles & Parabola",
        "Ellipse & Hyperbola",
        "3D Geometry",
        "Vector Algebra",
        "Statistics & Probability",
        "Mathematical Reasoning"
      ]
    };

    const load = (key, fallback) => {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch {
        return fallback;
      }
    };
    const save = (key, value) => localStorage.setItem(key, JSON.stringify(value));

    let topics = load(LS_KEYS.topics, []);
    let tests = load(LS_KEYS.tests, []);
    let settings = load(LS_KEYS.settings, { jeeDate: "", dailyTargetCount: 3 });
    let meta = load(LS_KEYS.meta, { lastActive: null, streak: 0 });

    const subjectSelect = document.getElementById("subject");
    const chapterSelect = document.getElementById("chapterSelect");

    function refreshChapterOptions() {
      const subj = subjectSelect.value;
      const list = CHAPTERS[subj] || [];
      chapterSelect.innerHTML = "";
      list.forEach(ch => {
        const opt = document.createElement("option");
        opt.value = ch;
        opt.textContent = ch;
        chapterSelect.appendChild(opt);
      });
    }
    subjectSelect.addEventListener("change", refreshChapterOptions);

    // Tabs
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll("main section").forEach(s => s.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
        if (btn.dataset.tab === "analysis") updateAnalysis();
      });
    });

    // Settings / days left
    const daysLeftSpan = document.getElementById("daysLeft");
    const jeeDateInput = document.getElementById("jeeDate");
    const dailyTargetInput = document.getElementById("dailyTargetCount");

    function updateDaysLeft() {
      if (!settings.jeeDate) {
        daysLeftSpan.textContent = "Set date";
        return;
      }
      const today = new Date();
      const target = new Date(settings.jeeDate + "T00:00:00");
      const diffMs = target - today;
      const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      daysLeftSpan.textContent = diffDays >= 0 ? diffDays : "Over";
    }

    document.getElementById("settingsForm").addEventListener("submit", e => {
      e.preventDefault();
      settings.jeeDate = jeeDateInput.value || "";
      settings.dailyTargetCount = Number(dailyTargetInput.value || 3);
      save(LS_KEYS.settings, settings);
      updateDaysLeft();
      updateDashboard();
      updateAnalysis();
      alert("Settings saved!");
    });

    document.getElementById("resetAll").addEventListener("click", () => {
      if (!confirm("This will delete all topics, tests and settings. Continue?")) return;
      topics = [];
      tests = [];
      settings = { jeeDate: "", dailyTargetCount: 3 };
      meta = { lastActive: null, streak: 0 };
      save(LS_KEYS.topics, topics);
      save(LS_KEYS.tests, tests);
      save(LS_KEYS.settings, settings);
      save(LS_KEYS.meta, meta);
      jeeDateInput.value = "";
      dailyTargetInput.value = 3;
      renderTopics();
      renderTests();
      updateDashboard();
      updateAnalysis();
      updateDaysLeft();
      refreshChapterOptions();
    });

    // Streak helper
    function markActiveToday() {
      const todayStr = new Date().toISOString().slice(0, 10);
      if (!meta.lastActive) {
        meta.lastActive = todayStr;
        meta.streak = 1;
      } else {
        const last = meta.lastActive;
        if (last === todayStr) {
          // same day, do nothing
        } else {
          const d1 = new Date(last + "T00:00:00");
          const d2 = new Date(todayStr + "T00:00:00");
          const diff = (d2 - d1) / (1000 * 60 * 60 * 24);
          if (diff === 1) meta.streak += 1;
          else meta.streak = 1;
          meta.lastActive = todayStr;
        }
      }
      save(LS_KEYS.meta, meta);
    }

    // Topic form
    document.getElementById("topicForm").addEventListener("submit", e => {
      e.preventDefault();
      const subject = subjectSelect.value;
      const chapter = chapterSelect.value;
      const extra = document.getElementById("topic").value.trim();
      const priority = document.getElementById("priority").value;
      const targetDate = document.getElementById("targetDate").value || "";
      if (!chapter) return;
      const finalTopic = extra ? chapter + " – " + extra : chapter;

      topics.push({
        id: Date.now(),
        subject,
        topic: finalTopic,
        priority,
        targetDate,
        status: "Pending"
      });
      save(LS_KEYS.topics, topics);
      markActiveToday();
      e.target.reset();
      refreshChapterOptions();
      renderTopics();
      updateDashboard();
      updateAnalysis();
    });

    const topicsTableBody = document.querySelector("#topicsTable tbody");
    const filterSubject = document.getElementById("filterSubject");
    const filterStatus = document.getElementById("filterStatus");

    function renderTopics() {
      const fs = filterSubject.value;
      const fst = filterStatus.value;
      topicsTableBody.innerHTML = "";
      topics
        .filter(t => (fs === "All" || t.subject === fs))
        .filter(t => (fst === "All" || t.status === fst))
        .forEach(t => {
          const tr = document.createElement("tr");
          const tagClass =
            t.subject === "Physics" ? "tag-phy" :
            t.subject === "Chemistry" ? "tag-chem" : "tag-math";
          tr.innerHTML = `
            <td><span class="tag ${tagClass}">${t.subject}</span></td>
            <td>${t.topic}</td>
            <td>${t.priority}</td>
            <td>${t.targetDate || "-"}</td>
            <td>
              <select data-id="${t.id}" class="status-select">
                <option ${t.status === "Pending" ? "selected" : ""}>Pending</option>
                <option ${t.status === "In Progress" ? "selected" : ""}>In Progress</option>
                <option ${t.status === "Done" ? "selected" : ""}>Done</option>
              </select>
            </td>
            <td>
              <button class="secondary small" data-del="${t.id}">✕</button>
            </td>
          `;
          topicsTableBody.appendChild(tr);
        });

      topicsTableBody.querySelectorAll(".status-select").forEach(sel => {
        sel.addEventListener("change", e => {
          const id = Number(e.target.dataset.id);
          const idx = topics.findIndex(t => t.id === id);
          if (idx !== -1) {
            topics[idx].status = e.target.value;
            save(LS_KEYS.topics, topics);
            markActiveToday();
            updateDashboard();
            updateAnalysis();
          }
        });
      });

      topicsTableBody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", e => {
          const id = Number(e.target.dataset.del);
          topics = topics.filter(t => t.id !== id);
          save(LS_KEYS.topics, topics);
          markActiveToday();
          renderTopics();
          updateDashboard();
          updateAnalysis();
        });
      });
    }

    filterSubject.addEventListener("change", renderTopics);
    filterStatus.addEventListener("change", renderTopics);
    document.getElementById("clearAllTopics").addEventListener("click", () => {
      if (!confirm("Remove all topics from the planner?")) return;
      topics = [];
      save(LS_KEYS.topics, topics);
      markActiveToday();
      renderTopics();
      updateDashboard();
      updateAnalysis();
    });

    // Practice / tests
    document.getElementById("testForm").addEventListener("submit", e => {
      e.preventDefault();
      const testType = document.getElementById("testType").value;
      const scoreVal = document.getElementById("score").value;
      const accuracyVal = document.getElementById("accuracy").value;
      const testDate = document.getElementById("testDate").value || "";
      const notes = document.getElementById("notes").value.trim();
      const score = scoreVal ? Number(scoreVal) : null;
      const accuracy = accuracyVal ? Number(accuracyVal) : null;

      tests.push({
        id: Date.now(),
        testType,
        score,
        accuracy,
        testDate,
        notes
      });
      save(LS_KEYS.tests, tests);
      markActiveToday();
      e.target.reset();
      renderTests();
      updateDashboard();
      updateAnalysis();
    });

    const testsTableBody = document.querySelector("#testsTable tbody");

    function renderTests() {
      testsTableBody.innerHTML = "";
      const recent = [...tests].sort((a, b) => b.id - a.id).slice(0, 10);
      recent.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.testType}</td>
          <td>${t.score ?? "-"}</td>
          <td>${t.accuracy ?? "-"}</td>
          <td>${t.testDate || "-"}</td>
          <td><button class="secondary small" data-deltest="${t.id}">✕</button></td>
        `;
        tr.title = t.notes || "";
        testsTableBody.appendChild(tr);
      });

      testsTableBody.querySelectorAll("button[data-deltest]").forEach(btn => {
        btn.addEventListener("click", e => {
          const id = Number(e.target.dataset.deltest);
          tests = tests.filter(t => t.id !== id);
          save(LS_KEYS.tests, tests);
          markActiveToday();
          renderTests();
          updateDashboard();
          updateAnalysis();
        });
      });
    }

    // Dashboard numbers
    function calculateProgressForSubject(subject) {
      const list = topics.filter(t => t.subject === subject);
      if (!list.length) return 0;
      const done = list.filter(t => t.status === "Done").length;
      return Math.round((done / list.length) * 100);
    }

    function updateDashboard() {
      document.getElementById("phyProgress").textContent = calculateProgressForSubject("Physics") + "%";
      document.getElementById("chemProgress").textContent = calculateProgressForSubject("Chemistry") + "%";
      document.getElementById("mathProgress").textContent = calculateProgressForSubject("Maths") + "%";

      document.getElementById("testsCount").textContent = tests.length;
      if (!tests.length) {
        document.getElementById("avgScore").textContent = 0;
        document.getElementById("avgAccuracy").textContent = 0;
      } else {
        const avg = (arr, key) =>
          Math.round(
            arr.reduce((sum, t) => sum + (typeof t[key] === "number" ? t[key] : 0), 0) /
            arr.filter(t => typeof t[key] === "number").length
          ) || 0;
        document.getElementById("avgScore").textContent = avg(tests, "score");
        document.getElementById("avgAccuracy").textContent = avg(tests, "accuracy");
      }

      const todayList = document.getElementById("todayList");
      todayList.innerHTML = "";
      const pending = topics.filter(t => t.status !== "Done");
      const dailyCount = settings.dailyTargetCount || 3;
      const selected = pending.slice(0, dailyCount);
      if (!selected.length) {
        const li = document.createElement("li");
        li.textContent = "No pending topics. Add more in the Study Planner.";
        todayList.appendChild(li);
      } else {
        selected.forEach(t => {
          const li = document.createElement("li");
          li.textContent = `${t.subject}: ${t.topic} (${t.priority})`;
          todayList.appendChild(li);
        });
      }
    }

    // Analysis section
    function updateAnalysis() {
      const total = topics.length;
      const done = topics.filter(t => t.status === "Done").length;
      document.getElementById("anTotalTopics").textContent = total;
      document.getElementById("anDoneTopics").textContent = done;
      document.getElementById("anOverallPct").textContent = total ? Math.round((done / total) * 100) + "%" : "0%";

      document.getElementById("anPhyPct").textContent = calculateProgressForSubject("Physics") + "%";
      document.getElementById("anChemPct").textContent = calculateProgressForSubject("Chemistry") + "%";
      document.getElementById("anMathPct").textContent = calculateProgressForSubject("Maths") + "%";

      document.getElementById("anStreak").textContent = meta.streak || 0;
      document.getElementById("anLastActive").textContent = meta.lastActive || "–";

      const recent = [...tests].sort((a, b) => b.id - a.id).slice(0, 5);
      if (!recent.length) {
        document.getElementById("anBestScore").textContent = 0;
        document.getElementById("anWorstScore").textContent = 0;
        document.getElementById("anRecentAvgScore").textContent = 0;
      } else {
        const scores = recent.map(t => typeof t.score === "number" ? t.score : 0);
        const best = Math.max(...scores);
        const worst = Math.min(...scores);
        const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
        document.getElementById("anBestScore").textContent = best;
        document.getElementById("anWorstScore").textContent = worst;
        document.getElementById("anRecentAvgScore").textContent = avg;
      }
    }

    // Initial load
    function init() {
      jeeDateInput.value = settings.jeeDate || "";
      dailyTargetInput.value = settings.dailyTargetCount || 3;
      refreshChapterOptions();
      renderTopics();
      renderTests();
      updateDashboard();
      updateAnalysis();
      updateDaysLeft();
    }

    init();
  </script>
</body>
</html>
