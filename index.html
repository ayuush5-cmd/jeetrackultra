<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study & Practice Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0b0f19;
      color: #f5f5f5;
    }
    header {
      padding: 16px 20px;
      background: #111827;
      border-bottom: 1px solid #1f2937;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }
    header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    main {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }
    h2, h3 {
      margin-top: 0;
      color: #e5e7eb;
    }
    section {
      background: #111827;
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 16px;
      border: 1px solid #1f2937;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .stat-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .stat {
      flex: 1;
      min-width: 100px;
    }
    .stat span.label {
      display: block;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .stat span.value {
      font-size: 1.2rem;
      font-weight: 600;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.85rem;
      color: #d1d5db;
    }
    input, select, textarea, button {
      width: 100%;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-family: inherit;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      margin-top: 10px;
      cursor: pointer;
      background: #2563eb;
      border-color: #2563eb;
      font-weight: 500;
    }
    button:hover {
      background: #1d4ed8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
      text-align: left;
    }
    th {
      background: #020617;
      color: #9ca3af;
      font-weight: 500;
    }
    tr:nth-child(even) td {
      background: #020617;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
    }
    .badge-high { background: #b91c1c; color: #fee2e2; }
    .badge-med { background: #92400e; color: #ffedd5; }
    .badge-low { background: #065f46; color: #d1fae5; }
    .tag-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #374151;
      margin-right: 4px;
    }
    .muted {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: 0.75rem;
      color: #e5e7eb;
    }
    #resetAll {
      background: #dc2626;
      border-color: #b91c1c;
    }
    #resetAll:hover {
      background: #b91c1c;
    }
    @media (max-width: 600px) {
      header h1 { font-size: 1.1rem; }
      main { padding: 10px; }
    }
  </style>
</head>
<body>
<header>
  <h1>JEE Study & Practice Tracker</h1>
  <p>All data stored locally in your browser. Close tab safely; nothing goes to a server.</p>
</header>

<main>

  <!-- Today’s Target -->
  <section>
    <div class="flex-between">
      <h2>Today’s Target</h2>
      <span class="muted" id="todayDate"></span>
    </div>
    <p class="muted">Focus topics pulled from your pending list. Finish at least one topic per subject daily.</p>
    <div id="todayTargets" class="chips"></div>
  </section>

  <!-- Top panels -->
  <div class="grid">

    <!-- Overall Study Planner -->
    <section>
      <h2>Overall Progress</h2>
      <p class="muted">Quick view of topic completion across Physics, Chemistry and Maths.</p>
      <div class="stat-row">
        <div class="stat">
          <span class="label">Physics</span>
          <span class="value" id="phyPercent">0%</span>
        </div>
        <div class="stat">
          <span class="label">Chemistry</span>
          <span class="value" id="chemPercent">0%</span>
        </div>
        <div class="stat">
          <span class="label">Maths</span>
          <span class="value" id="mathPercent">0%</span>
        </div>
      </div>
      <hr style="border-color:#1f2937;margin:10px 0;">
      <div class="stat-row">
        <div class="stat">
          <span class="label">Total topics</span>
          <span class="value" id="totalTopics">0</span>
        </div>
        <div class="stat">
          <span class="label">Completed</span>
          <span class="value" id="completedTopics">0</span>
        </div>
        <div class="stat">
          <span class="label">Overall %</span>
          <span class="value" id="overallPercent">0%</span>
        </div>
      </div>
    </section>

    <!-- Practice Snapshot -->
    <section>
      <h2>Practice Snapshot</h2>
      <p class="muted">Mocks & PYQs – keep an eye on accuracy and attempts.</p>
      <div class="stat-row">
        <div class="stat">
          <span class="label">Tests logged</span>
          <span class="value" id="testsLogged">0</span>
        </div>
        <div class="stat">
          <span class="label">Avg. score (/300)</span>
          <span class="value" id="avgScore">0</span>
        </div>
        <div class="stat">
          <span class="label">Avg. accuracy (%)</span>
          <span class="value" id="avgAccuracy">0</span>
        </div>
      </div>
      <hr style="border-color:#1f2937;margin:10px 0;">
      <div class="stat-row">
        <div class="stat">
          <span class="label">Best score</span>
          <span class="value" id="bestScore">0</span>
        </div>
        <div class="stat">
          <span class="label">Worst score</span>
          <span class="value" id="worstScore">0</span>
        </div>
        <div class="stat">
          <span class="label">Recent avg score</span>
          <span class="value" id="recentAvgScore">0</span>
        </div>
      </div>
    </section>

    <!-- Consistency -->
    <section>
      <h2>Consistency</h2>
      <p class="muted">Try not to break your streak.</p>
      <div class="stat-row">
        <div class="stat">
          <span class="label">Current study streak</span>
          <span class="value" id="streakDays">0 days</span>
        </div>
        <div class="stat">
          <span class="label">Last active</span>
          <span class="value" id="lastActive">–</span>
        </div>
      </div>
    </section>

  </div>

  <!-- Study planner: add & list topics -->
  <section>
    <h2>Add Topic</h2>
    <p class="muted">Choose subject & chapter; optionally add subtopics.</p>

    <form id="topicForm">
      <div class="grid">
        <div>
          <label>Subject</label>
          <select id="topicSubject" required>
            <option value="">Select subject</option>
            <option value="Physics">Physics</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Maths">Maths</option>
          </select>
        </div>
        <div>
          <label>Topic / Chapter</label>
          <input id="topicName" type="text" placeholder="e.g. Electrostatics" required>
        </div>
        <div>
          <label>Priority</label>
          <select id="topicPriority" required>
            <option value="High">High</option>
            <option value="Medium" selected>Medium</option>
            <option value="Low">Low</option>
          </select>
        </div>
        <div>
          <label>Target date</label>
          <input id="topicTarget" type="date">
        </div>
      </div>
      <label>Subtopics (optional, comma separated)</label>
      <input id="topicSubtopics" type="text" placeholder="Kinematics 1D, Kinematics 2D">
      <button type="submit">Add Topic</button>
    </form>

    <hr style="border-color:#1f2937;margin:12px 0;">

    <h3>Filter & Quick View</h3>
    <div class="grid">
      <div>
        <label>Subject filter</label>
        <select id="filterSubject">
          <option value="All">All</option>
          <option value="Physics">Physics</option>
          <option value="Chemistry">Chemistry</option>
          <option value="Maths">Maths</option>
        </select>
      </div>
      <div>
        <label>Status filter</label>
        <select id="filterStatus">
          <option value="All">All</option>
          <option value="Pending">Pending</option>
          <option value="Done">Done</option>
        </select>
      </div>
      <div>
        <label>Priority filter</label>
        <select id="filterPriority">
          <option value="All">All</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>
    </div>

    <h3 style="margin-top:12px;">Topic List</h3>
    <div class="muted">Use the “Mark done” button after you feel confident with a topic.</div>
    <table>
      <thead>
        <tr>
          <th>Subject</th>
          <th>Topic</th>
          <th>Priority</th>
          <th>Target</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="topicTableBody"></tbody>
    </table>
  </section>

  <!-- Practice tracker: tests & mistakes -->
  <section>
    <h2>Log Mock / PYQ</h2>
    <p class="muted">Track each test with score, auto-calculated accuracy, and a short reflection.</p>

    <form id="testForm">
      <div class="grid">
        <div>
          <label>Type</label>
          <select id="testType" required>
            <option value="">Select type</option>
            <option value="Mock">Mock</option>
            <option value="PYQ">PYQ</option>
          </select>
        </div>
        <div>
          <label>Score (/300)</label>
          <input type="number" id="testScore" min="0" max="300" required>
        </div>
        <div>
          <label>Total questions</label>
          <input type="number" id="testTotalQ" min="1" required>
        </div>
        <div>
          <label>Correct questions</label>
          <input type="number" id="testCorrectQ" min="0" required>
        </div>
        <div>
          <label>Accuracy (%)</label>
          <input type="number" id="testAccuracy" readonly>
        </div>
      </div>
      <label>Reflection / mistakes (short)</label>
      <textarea id="testReflection" placeholder="Key mistakes, chapters to revise, silly errors, guessing, time management, etc."></textarea>
      <button type="submit">Save Test</button>
    </form>

    <h3 style="margin-top:16px;">Recent Tests</h3>
    <p class="muted">Last few entries to quickly recall what to fix.</p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Score</th>
          <th>Acc%</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="recentTestsBody"></tbody>
    </table>
  </section>

  <section id="mistakeLogSection">
    <h2>Previously Made Mistakes</h2>
    <p class="muted">Review this before new tests so you do not repeat the same errors.</p>
    <ul id="mistakeLogList" class="muted"></ul>
  </section>

  <!-- Settings & reset -->
  <section>
    <h2>Basic Settings</h2>
    <p class="muted">Set your JEE Main target date and daily dashboard load.</p>
    <div class="grid">
      <div>
        <label>JEE Main target date</label>
        <input type="date" id="targetExamDate">
      </div>
      <div>
        <label>Daily topics to surface</label>
        <input type="number" id="dailyTopicCount" min="1" value="3">
      </div>
    </div>
    <button id="resetAll" style="margin-top:14px;">Reset everything (topics, tests, streak)</button>
    <p class="muted" style="margin-top:6px;">All data stays in this browser (localStorage). If you clear site data, everything resets.</p>
  </section>

</main>

<script>
  // ---------- Helpers for localStorage ----------
  function getArray(key) {
    return JSON.parse(localStorage.getItem(key) || '[]');
  }
  function setArray(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  // ---------- Topics: structure & CRUD ----------
  function getTopics() {
    return getArray('topics');
  }
  function saveTopics(topics) {
    setArray('topics', topics);
  }

  // ---------- Tests ----------
  function getTests() {
    return getArray('tests');
  }
  function saveTests(tests) {
    setArray('tests', tests);
  }

  // ---------- Date helpers ----------
  function todayStr() {
    return new Date().toISOString().split('T')[0];
  }

  // ---------- Topic form submit ----------
  const topicForm = document.getElementById('topicForm');
  if (topicForm) {
    topicForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const subject = document.getElementById('topicSubject').value;
      const name = document.getElementById('topicName').value.trim();
      const priority = document.getElementById('topicPriority').value;
      const target = document.getElementById('topicTarget').value;
      const subtopics = document.getElementById('topicSubtopics').value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      if (!subject || !name) return;

      const topics = getTopics();
      topics.push({
        id: Date.now(),
        subject,
        name,
        priority,
        target,
        subtopics,
        status: 'Pending',
        createdAt: todayStr(),
        doneAt: null
      });
      saveTopics(topics);
      topicForm.reset();
      renderTopics();
      updateStudyStats();
      updateTodayTargets();
    });
  }

  // ---------- Topic table render & filters ----------
  const topicTableBody = document.getElementById('topicTableBody');
  const filterSubject = document.getElementById('filterSubject');
  const filterStatus = document.getElementById('filterStatus');
  const filterPriority = document.getElementById('filterPriority');

  function renderTopics() {
    if (!topicTableBody) return;
    const topics = getTopics();
    const subjectFilter = filterSubject ? filterSubject.value : 'All';
    const statusFilter = filterStatus ? filterStatus.value : 'All';
    const priorityFilter = filterPriority ? filterPriority.value : 'All';

    const filtered = topics.filter(t => {
      if (subjectFilter !== 'All' && t.subject !== subjectFilter) return false;
      if (statusFilter !== 'All' && t.status !== statusFilter) return false;
      if (priorityFilter !== 'All' && t.priority !== priorityFilter) return false;
      return true;
    });

    topicTableBody.innerHTML = '';
    if (!filtered.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.textContent = 'No topics added yet.';
      td.className = 'muted';
      tr.appendChild(td);
      topicTableBody.appendChild(tr);
      return;
    }

    filtered.forEach(t => {
      const tr = document.createElement('tr');

      // Subject
      const subjectTd = document.createElement('td');
      subjectTd.textContent = t.subject;
      tr.appendChild(subjectTd);

      // Topic + subtopics
      const topicTd = document.createElement('td');
      const nameDiv = document.createElement('div');
      nameDiv.textContent = t.name;
      topicTd.appendChild(nameDiv);

      if (t.subtopics && t.subtopics.length) {
        const subDiv = document.createElement('div');
        subDiv.className = 'muted';
        subDiv.style.fontSize = '0.75rem';
        subDiv.textContent = 'Sub: ' + t.subtopics.join(', ');
        topicTd.appendChild(subDiv);
      }
      tr.appendChild(topicTd);

      // Priority
      const prTd = document.createElement('td');
      const badge = document.createElement('span');
      badge.textContent = t.priority;
      badge.classList.add('badge');
      if (t.priority === 'High') badge.classList.add('badge-high');
      else if (t.priority === 'Medium') badge.classList.add('badge-med');
      else badge.classList.add('badge-low');
      prTd.appendChild(badge);
      tr.appendChild(prTd);

      // Target
      const targetTd = document.createElement('td');
      targetTd.textContent = t.target || '–';
      tr.appendChild(targetTd);

      // Status
      const statusTd = document.createElement('td');
      statusTd.textContent = t.status;
      statusTd.className = 'muted';
      tr.appendChild(statusTd);

      // Action
      const actionTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = t.status === 'Done' ? 'Mark pending' : 'Mark done';
      btn.style.padding = '4px 8px';
      btn.style.fontSize = '0.75rem';
      btn.addEventListener('click', () => toggleTopicStatus(t.id));
      actionTd.appendChild(btn);
      tr.appendChild(actionTd);

      topicTableBody.appendChild(tr);
    });
  }

  function toggleTopicStatus(id) {
    const topics = getTopics();
    const idx = topics.findIndex(t => t.id === id);
    if (idx === -1) return;
    const topic = topics[idx];
    if (topic.status === 'Done') {
      topic.status = 'Pending';
      topic.doneAt = null;
    } else {
      topic.status = 'Done';
      topic.doneAt = todayStr();
    }
    topics[idx] = topic;
    saveTopics(topics);
    renderTopics();
    updateStudyStats();
    updateTodayTargets();
    updateStreak(topic.doneAt ? topic.doneAt : todayStr());
  }

  if (filterSubject) filterSubject.addEventListener('change', renderTopics);
  if (filterStatus) filterStatus.addEventListener('change', renderTopics);
  if (filterPriority) filterPriority.addEventListener('change', renderTopics);

  // ---------- Study stats (overall & subject-wise) ----------
  function updateStudyStats() {
    const topics = getTopics();
    const total = topics.length;
    const done = topics.filter(t => t.status === 'Done').length;

    const totalTopicsEl = document.getElementById('totalTopics');
    const completedTopicsEl = document.getElementById('completedTopics');
    const overallPercentEl = document.getElementById('overallPercent');

    if (totalTopicsEl) totalTopicsEl.textContent = total;
    if (completedTopicsEl) completedTopicsEl.textContent = done;
    if (overallPercentEl) {
      const pct = total ? ((done / total) * 100).toFixed(1) : '0';
      overallPercentEl.textContent = pct + '%';
    }

    const subjects = ['Physics', 'Chemistry', 'Maths'];
    const subjectPercents = { Physics: 0, Chemistry: 0, Maths: 0 };

    subjects.forEach(sub => {
      const all = topics.filter(t => t.subject === sub).length;
      const completed = topics.filter(t => t.subject === sub && t.status === 'Done').length;
      subjectPercents[sub] = all ? (completed / all) * 100 : 0;
    });

    const phyEl = document.getElementById('phyPercent');
    const chemEl = document.getElementById('chemPercent');
    const mathEl = document.getElementById('mathPercent');
    if (phyEl) phyEl.textContent = subjectPercents.Physics.toFixed(1) + '%';
    if (chemEl) chemEl.textContent = subjectPercents.Chemistry.toFixed(1) + '%';
    if (mathEl) mathEl.textContent = subjectPercents.Maths.toFixed(1) + '%';
  }

  // ---------- Today’s Targets (from pending list) ----------
  function updateTodayTargets() {
    const container = document.getElementById('todayTargets');
    if (!container) return;

    const dailyCountInput = document.getElementById('dailyTopicCount');
    const dailyCount = dailyCountInput ? Number(dailyCountInput.value || 3) : 3;

    const topics = getTopics();
    const pending = topics.filter(t => t.status === 'Pending');

    pending.sort((a, b) => {
      const prOrder = { High: 0, Medium: 1, Low: 2 };
      const pa = prOrder[a.priority] ?? 2;
      const pb = prOrder[b.priority] ?? 2;
      if (pa !== pb) return pa - pb;
      if (a.target && b.target) return a.target.localeCompare(b.target);
      if (a.target && !b.target) return -1;
      if (!a.target && b.target) return 1;
      return a.createdAt.localeCompare(b.createdAt);
    });

    const pick = pending.slice(0, dailyCount);

    container.innerHTML = '';
    if (!pick.length) {
      const span = document.createElement('span');
      span.className = 'muted';
      span.textContent = 'No pending topics. Add some or mark a few back to pending.';
      container.appendChild(span);
      return;
    }

    pick.forEach(t => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = `${t.subject}: ${t.name}`;
      container.appendChild(chip);
    });
  }

  // ---------- Practice: auto accuracy field ----------
  const totalQInput = document.getElementById('testTotalQ');
  const correctQInput = document.getElementById('testCorrectQ');
  const accuracyInput = document.getElementById('testAccuracy');

  function updateAccuracyField() {
    const total = parseInt(totalQInput.value, 10);
    const correct = parseInt(correctQInput.value, 10);
    if (!isNaN(total) && total > 0 && !isNaN(correct) && correct >= 0 && correct <= total) {
      const acc = (correct / total) * 100;
      accuracyInput.value = acc.toFixed(1);
    } else {
      accuracyInput.value = '';
    }
  }
  if (totalQInput && correctQInput) {
    totalQInput.addEventListener('input', updateAccuracyField);
    correctQInput.addEventListener('input', updateAccuracyField);
  }

  // ---------- Practice: handle test submit ----------
  const testForm = document.getElementById('testForm');
  if (testForm) {
    testForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const type = document.getElementById('testType').value;
      const score = Number(document.getElementById('testScore').value);
      const totalQ = Number(document.getElementById('testTotalQ').value);
      const correctQ = Number(document.getElementById('testCorrectQ').value);
      const reflection = document.getElementById('testReflection').value.trim();

      if (!type || isNaN(score) || !totalQ || totalQ <= 0 || correctQ < 0 || correctQ > totalQ) {
        alert('Please fill test type, score and valid question details.');
        return;
      }

      const accuracy = (correctQ / totalQ) * 100;

      const tests = getTests();
      tests.push({
        id: Date.now(),
        type,
        score,
        totalQ,
        correctQ,
        accuracy,
        reflection,
        date: todayStr()
      });
      saveTests(tests);

      this.reset();
      if (accuracyInput) accuracyInput.value = '';

      renderTests();
      updatePracticeStats();
      updateMistakeLog();
      updateStreak(todayStr());
    });
  }

  // ---------- Practice: snapshot & test performance ----------
  function updatePracticeStats() {
    const tests = getTests();
    const n = tests.length;

    const testsLoggedEl = document.getElementById('testsLogged');
    const avgScoreEl = document.getElementById('avgScore');
    const avgAccuracyEl = document.getElementById('avgAccuracy');
    const bestScoreEl = document.getElementById('bestScore');
    const worstScoreEl = document.getElementById('worstScore');
    const recentAvgScoreEl = document.getElementById('recentAvgScore');

    if (testsLoggedEl) testsLoggedEl.textContent = n;

    let avgScore = 0, avgAcc = 0, best = 0, worst = 0, recentAvg = 0;
    if (n) {
      const totalScore = tests.reduce((s, t) => s + (t.score || 0), 0);
      const totalAcc = tests.reduce((s, t) => s + (t.accuracy || 0), 0);
      avgScore = totalScore / n;
      avgAcc = totalAcc / n;
      best = Math.max(...tests.map(t => t.score || 0));
      worst = Math.min(...tests.map(t => t.score || 0));

      const recent = tests.slice(-5);
      const recentTotalScore = recent.reduce((s, t) => s + (t.score || 0), 0);
      recentAvg = recentTotalScore / recent.length;
    }

    if (avgScoreEl) avgScoreEl.textContent = avgScore.toFixed(1);
    if (avgAccuracyEl) avgAccuracyEl.textContent = avgAcc.toFixed(1);
    if (bestScoreEl) bestScoreEl.textContent = best.toFixed(1);
    if (worstScoreEl) worstScoreEl.textContent = worst.toFixed(1);
    if (recentAvgScoreEl) recentAvgScoreEl.textContent = recentAvg.toFixed(1);
  }

  function renderTests() {
    const tbody = document.getElementById('recentTestsBody');
    if (!tbody) return;
    const tests = getTests().sort((a, b) => b.id - a.id);
    const recent = tests.slice(0, 5);
    tbody.innerHTML = '';
    if (!recent.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.textContent = 'No tests logged yet.';
      td.className = 'muted';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    recent.forEach(t => {
      const tr = document.createElement('tr');
      const typeTd = document.createElement('td');
      const scoreTd = document.createElement('td');
      const accTd = document.createElement('td');
      const dateTd = document.createElement('td');

      typeTd.textContent = t.type;
      scoreTd.textContent = t.score;
      accTd.textContent = t.accuracy.toFixed(1);
      dateTd.textContent = t.date;

      tr.appendChild(typeTd);
      tr.appendChild(scoreTd);
      tr.appendChild(accTd);
      tr.appendChild(dateTd);
      tbody.appendChild(tr);
    });
  }

  // ---------- Mistake log ----------
  function updateMistakeLog() {
    const list = document.getElementById('mistakeLogList');
    if (!list) return;
    const tests = getTests();

    const withMistakes = tests
      .filter(t => t.reflection && t.reflection.trim().length)
      .sort((a, b) => b.id - a.id)
      .slice(0, 10);

    list.innerHTML = '';
    if (!withMistakes.length) {
      const li = document.createElement('li');
      li.textContent = 'No logged mistakes yet. Add reflections when you log tests.';
      list.appendChild(li);
      return;
    }

    withMistakes.forEach(t => {
      const li = document.createElement('li');
      li.textContent = `${t.date} • ${t.type} • Acc: ${t.accuracy.toFixed(1)}% • ${t.reflection}`;
      list.appendChild(li);
    });
  }

  // ---------- Streak tracking ----------
  function getMeta() {
    return JSON.parse(localStorage.getItem('meta') || '{"streak":0,"lastActive":null}');
  }
  function saveMeta(meta) {
    localStorage.setItem('meta', JSON.stringify(meta));
  }

  function updateStreak(actionDateStr) {
    if (!actionDateStr) return;
    const meta = getMeta();
    const today = actionDateStr;
    const last = meta.lastActive;

    if (!last) {
      meta.streak = 1;
    } else {
      const lastDate = new Date(last);
      const currDate = new Date(today);
      const diffDays = Math.floor((currDate - lastDate) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) {
        // same day; streak unchanged
      } else if (diffDays === 1) {
        meta.streak = (meta.streak || 0) + 1;
      } else if (diffDays > 1) {
        meta.streak = 1;
      }
    }

    meta.lastActive = today;
    saveMeta(meta);
    renderStreak();
  }

  function renderStreak() {
    const meta = getMeta();
    const streakEl = document.getElementById('streakDays');
    const lastEl = document.getElementById('lastActive');
    if (streakEl) streakEl.textContent = (meta.streak || 0) + ' days';
    if (lastEl) lastEl.textContent = meta.lastActive || '–';
  }

  // ---------- Settings: daily topics & exam date ----------
  const dailyTopicCountInput = document.getElementById('dailyTopicCount');
  const targetExamDateInput = document.getElementById('targetExamDate');

  function loadSettings() {
    const settings = JSON.parse(localStorage.getItem('settings') || '{}');
    if (settings.dailyTopicCount && dailyTopicCountInput) {
      dailyTopicCountInput.value = settings.dailyTopicCount;
    }
    if (settings.targetExamDate && targetExamDateInput) {
      targetExamDateInput.value = settings.targetExamDate;
    }
  }

  function saveSettings() {
    const s = {
      dailyTopicCount: dailyTopicCountInput ? Number(dailyTopicCountInput.value || 3) : 3,
      targetExamDate: targetExamDateInput ? targetExamDateInput.value : null
    };
    localStorage.setItem('settings', JSON.stringify(s));
    updateTodayTargets();
  }

  if (dailyTopicCountInput) dailyTopicCountInput.addEventListener('change', saveSettings);
  if (targetExamDateInput) targetExamDateInput.addEventListener('change', saveSettings);

  // ---------- Reset all ----------
  const resetBtn = document.getElementById('resetAll');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      if (!confirm('Reset topics, tests, streak and settings?')) return;
      localStorage.removeItem('topics');
      localStorage.removeItem('tests');
      localStorage.removeItem('meta');
      localStorage.removeItem('settings');
      renderTopics();
      updateStudyStats();
      updateTodayTargets();
      renderTests();
      updatePracticeStats();
      updateMistakeLog();
      renderStreak();
    });
  }

  // ---------- Initial load ----------
  document.addEventListener('DOMContentLoaded', () => {
    const todayDateEl = document.getElementById('todayDate');
    if (todayDateEl) {
      const d = new Date();
      todayDateEl.textContent = d.toLocaleDateString(undefined, {
        weekday: 'short',
        day: 'numeric',
        month: 'short'
      });
    }

    loadSettings();
    renderTopics();
    updateStudyStats();
    updateTodayTargets();
    renderTests();
    updatePracticeStats();
    updateMistakeLog();
    renderStreak();
  });
</script>

</body>
</html>
